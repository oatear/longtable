@if (isVisible()) {
<div #panel (mousedown)="$event.stopPropagation()"
  class="fixed w-80 rounded-[10px] shadow-2xl border border-[var(--lt-popup-border,theme(colors.slate.200))] flex flex-col z-[1000]"
  [style.left]="position().x + 'px'" [style.top]="position().y + 'px'" [style.background]="'var(--lt-popup-bg, white)'">
  <div (mousedown)="onDragStart($event)"
    class="flex items-center justify-between p-2 border-b border-[var(--lt-border-default,theme(colors.slate.200))] cursor-move">
    <h3 class="font-semibold text-[var(--lt-text-primary,theme(colors.gray.800))]"
      [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Find and Replace</h3>
    <button (click)="close.emit()"
      class="p-1 rounded-full text-[var(--lt-icon-default,theme(colors.gray.500))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.slate.200))]">
      <i class="pi pi-times text-[14px]"></i>
    </button>
  </div>
  <div class="p-3 space-y-3">
    <div class="relative">
      <input #findInput type="text" [(ngModel)]="findQuery" (keydown)="onFindKeyDown($event)" placeholder="Find"
        class="w-full px-2 py-1.5 pr-16 bg-[var(--lt-input-bg,white)] border border-transparent hover:border-[var(--lt-border-default,theme(colors.slate.300))] rounded-[10px] shadow-sm focus:outline-none focus:border-[var(--lt-border-editing,theme(colors.blue.500))] focus:ring-1 focus:ring-[var(--lt-border-editing,theme(colors.blue.500))] text-[var(--lt-text-primary,inherit)]"
        [style.fontSize]="'var(--lt-font-input, 14px)'">
      @if (findQuery()) {
      <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[var(--lt-icon-default,theme(colors.gray.500))]"
        [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
        {{ resultsCount() > 0 ? (currentIndex() + 1) : 0 }} of {{ resultsCount() }}
      </span>
      }
    </div>
    <input type="text" [(ngModel)]="replaceQuery" (keydown)="$event.stopPropagation()" placeholder="Replace with"
      class="w-full px-2 py-1.5 bg-[var(--lt-input-bg,white)] border border-transparent hover:border-[var(--lt-border-default,theme(colors.slate.300))] rounded-[10px] shadow-sm focus:outline-none focus:border-[var(--lt-border-editing,theme(colors.blue.500))] focus:ring-1 focus:ring-[var(--lt-border-editing,theme(colors.blue.500))] text-[var(--lt-text-primary,inherit)]"
      [style.fontSize]="'var(--lt-font-input, 14px)'">

    <div class="flex items-center justify-between">
      <div class="flex gap-4">
        <button (click)="navigatePrev.emit()" [disabled]="resultsCount() === 0"
          class="p-1.5 rounded text-[var(--lt-text-primary,theme(colors.gray.600))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.slate.200))] disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-chevron-left"></i>
        </button>
        <button (click)="navigateNext.emit()" [disabled]="resultsCount() === 0"
          class="p-1.5 rounded text-[var(--lt-text-primary,theme(colors.gray.600))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.slate.200))] disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="pi pi-chevron-right"></i>
        </button>
      </div>
      <div class="flex gap-2">
        <button (click)="onReplace()" [disabled]="currentIndex() < 0"
          class="px-3 py-1 text-[var(--lt-text-primary,theme(colors.gray.700))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.gray.100))] rounded-[10px] border border-[var(--lt-border-default,theme(colors.slate.300))] disabled:opacity-50 disabled:cursor-not-allowed"
          [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
          Replace
        </button>
        <button (click)="onReplaceAll()" [disabled]="resultsCount() === 0"
          class="px-3 py-1 text-[var(--lt-text-primary,theme(colors.gray.700))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.gray.100))] rounded-[10px] border border-[var(--lt-border-default,theme(colors.slate.300))] disabled:opacity-50 disabled:cursor-not-allowed"
          [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
          Replace All
        </button>
      </div>
    </div>

    <div class="border-t border-[var(--lt-border-default,theme(colors.slate.200))] pt-3 space-y-2">
      <label class="flex items-center gap-2 text-[var(--lt-text-primary,theme(colors.gray.700))]"
        [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
        <input type="checkbox" [ngModel]="matchCase()" (ngModelChange)="onMatchCaseChange($event)"
          class="h-4 w-4 rounded border border-[var(--lt-checkbox-border,theme(colors.slate.300))] focus:ring-[var(--lt-icon-active,theme(colors.blue.600))] bg-[var(--lt-checkbox-bg,white)] accent-[var(--lt-icon-active,theme(colors.blue.600))]">
        Match case
      </label>
      <label class="flex items-center gap-2 text-[var(--lt-text-primary,theme(colors.gray.700))]"
        [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
        <input type="checkbox" [ngModel]="matchEntireCell()" (ngModelChange)="onMatchEntireCellChange($event)"
          class="h-4 w-4 rounded border border-[var(--lt-checkbox-border,theme(colors.slate.300))] focus:ring-[var(--lt-icon-active,theme(colors.blue.600))] bg-[var(--lt-checkbox-bg,white)] accent-[var(--lt-icon-active,theme(colors.blue.600))]">
        Match entire cell contents
      </label>
    </div>
  </div>
</div>
}