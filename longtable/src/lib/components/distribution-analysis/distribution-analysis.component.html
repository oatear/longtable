<div class="relative h-full">
  <div class="pb-2 mb-4">
      <div class="flex justify-between items-center">
          <div class="flex items-center gap-3">
              <h3 class="font-semibold text-[var(--lt-text-primary,theme(colors.gray.800))]" [style.fontSize]="'var(--lt-font-modal-title, 18px)'">Distribution Analysis</h3>
              @if (state()().view === 'table' && tableData()) {
                  <button (click)="copyTableDataToClipboard()" [attr.title]="copyState() === 'idle' ? 'Copy table data' : 'Copied!'" class="p-1.5 leading-none h-7 w-7 rounded-full text-[var(--lt-icon-default,theme(colors.gray.500))] hover:bg-[var(--lt-icon-hover-bg,theme(colors.slate.200))] focus:outline-none flex items-center justify-center transition-colors">
                      @if (copyState() === 'copied') {
                          <i class="pi pi-check text-[14px] text-green-500"></i>
                      } @else {
                          <i class="pi pi-copy text-[14px]"></i>
                      }
                  </button>
              }
          </div>
          <div class="flex items-center p-0.5 bg-[var(--lt-bg-header,theme(colors.slate.200))] rounded-[10px]">
              <button (click)="setView('chart')" [class]="'px-2 py-1 rounded-lg ' + (state()().view === 'chart' ? 'bg-[var(--lt-bg-header-hover)] shadow font-medium text-[var(--lt-text-primary)]' : 'text-[var(--lt-text-header)]')" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Chart</button>
              <button (click)="setView('table')" [class]="'px-2 py-1 rounded-lg ' + (state()().view === 'table' ? 'bg-[var(--lt-bg-header-hover)] shadow font-medium text-[var(--lt-text-primary)]' : 'text-[var(--lt-text-header)]')" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Table</button>
          </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
          <div>
              <label class="block font-medium text-[var(--lt-text-primary,theme(colors.gray.700))]" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Analyze</label>
              <select [ngModel]="state()().analysisField" (ngModelChange)="onAnalysisFieldChange($event)" class="mt-1 block w-full pl-3 pr-8 py-1.5 border border-transparent hover:border-[var(--lt-border-default,theme(colors.slate.300))] focus:outline-none focus:ring-[var(--lt-border-editing,theme(colors.blue.500))] focus:border-[var(--lt-border-editing,theme(colors.blue.500))] rounded-[10px] bg-[var(--lt-input-bg,white)] text-[var(--lt-text-primary,inherit)]" [style.fontSize]="'var(--lt-font-input, 14px)'">
                  <option value="null">Select Field</option>
                  @for (col of analysisOptions(); track col.value) { <option [value]="col.value">{{ col.label }}</option> }
              </select>
          </div>
          <div>
              <label class="block font-medium text-[var(--lt-text-primary,theme(colors.gray.700))]" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Stack by</label>
              <select [ngModel]="state()().stackByField" (ngModelChange)="onStackByChange($event)" [disabled]="state()().analysisField === null" class="mt-1 block w-full pl-3 pr-8 py-1.5 border border-transparent hover:border-[var(--lt-border-default,theme(colors.slate.300))] focus:outline-none focus:ring-[var(--lt-border-editing,theme(colors.blue.500))] focus:border-[var(--lt-border-editing,theme(colors.blue.500))] rounded-[10px] bg-[var(--lt-input-bg,white)] text-[var(--lt-text-primary,inherit)] disabled:opacity-50" [style.fontSize]="'var(--lt-font-input, 14px)'">
                  <option value="null">None</option>
                  @for (col of stackByOptions(); track col.value) { <option [value]="col.value">{{ col.label }}</option> }
              </select>
          </div>
      </div>
  </div>
  
  @if (state()().view === 'chart') {
      <h4 class="text-center font-medium text-[var(--lt-text-primary,theme(colors.gray.700))] mb-2 truncate" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">{{ chartTitle() }}</h4>
      <div #distributionChartContainer class="w-full overflow-x-auto modal-scroll-content"></div>
  } @else {
      @if (tableData(); as tableData) {
          <div class="max-h-[400px] overflow-y-auto border rounded-[10px] border-[var(--lt-border-default,theme(colors.slate.700))] modal-scroll-content">
              <table class="w-full text-left text-[var(--lt-text-primary,theme(colors.gray.500))]" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">
                  <thead class="font-semibold bg-[var(--lt-bg-header,theme(colors.slate.100))] text-[var(--lt-text-header,theme(colors.gray.600))] sticky top-0">
                      <tr>
                          @for(header of tableData.headers; track header) {
                              <th scope="col" class="px-4 py-2">{{ header }}</th>
                          }
                      </tr>
                  </thead>
                  <tbody>
                      @if (!tableData.isStacked) {
                          @for (row of tableData.rows; track row.value) {
                              <tr class="border-b border-[var(--lt-border-default,theme(colors.slate.700))]">
                                  <td class="px-4 py-2">{{ row.value }}</td>
                                  <td class="px-4 py-2">{{ row.count }}</td>
                              </tr>
                          }
                      } @else {
                          @for (row of tableData.rows; track row.primaryValue) {
                              <tr class="border-b border-[var(--lt-border-default,theme(colors.slate.700))]">
                                  <td class="px-4 py-2">{{ row.primaryValue }}</td>
                                  @for (key of tableData.stackKeys; track key) {
                                      <td class="px-4 py-2">{{ row[key] }}</td>
                                  }
                                  <td class="px-4 py-2 font-semibold">{{ row.total }}</td>
                              </tr>
                          }
                      }
                  </tbody>
              </table>
          </div>
      } @else {
          <div class="h-[400px] flex items-center justify-center">
              <p class="text-center text-gray-500 dark:text-slate-400 p-4" [style.fontSize]="'var(--lt-font-modal-content, 14px)'">Select a field to analyze.</p>
          </div>
      }
  }
  <div #statsTooltip class="fixed opacity-0 pointer-events-none z-[120] bg-slate-800 text-white text-sm rounded-md shadow-lg p-2 leading-tight transition-opacity duration-200 max-w-xs" [style.font-family]="'var(--lt-font-family-mono, monospace)'"></div>
</div>